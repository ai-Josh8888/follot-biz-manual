# Bizトーク機能

# 【テスト仕様書】顧客チャット機能

## 基本情報

- **作成日**: 2025年8月6日
- **対象バージョン**: リリース前最終版
- **テスト対象**: 顧客チャット機能全般（Bizトーク）

---

## 3. 顧客チャット機能 (/businesschat)

### 基本情報

- **URL**: `/businesschat`, `/businesschat/:roomId`, `/businesschat/:roomId/:subContentId`
- **関連機能**: メール受信処理 (`functions-node22/src/receiveEmail.ts`), 権限管理 (`src/core/domains/rule.ts`)
- **機能概要**: 外部顧客からのメールをトリガーとして、顧客情報・専用ルームを自動生成し、顧客とのコミュニケーションを一元管理する機能。社内メンバーは本画面から顧客への返信を行う。メッセージ送信には承認フローが介在する場合があり、ユーザーのロールに応じて実行可能な操作が制限される。

### テスト項目

### 3.1 メール受信〜ルーム自動生成テスト（バックエンド）

| 項目ID | 操作 | 期待結果 | 実施者 | 結果 | 備考 |  |
| --- | --- | --- | --- | --- | --- | --- |
| B-BE-001 | **新規顧客**から指定メールアドレスにメールを送信する（通常形式） | 1. 新規顧客として登録される<br>2. その顧客専用の新規ルームが作成される<br>3. メールの件名・本文・添付ファイルが最初のメッセージとしてルームに登録される<br>4. 担当者にタスクが自動で割り当てられる | 25/10/23　井上文 | △ | `handleReceivedEmail`のシナリオ
Yashoo、Gmailで来たものに関しては正確に読み取れるらしいが、
[outlookでメールすると文字化けする](https://www.notion.so/outlook-25777fe36e828017a623c07ccc80cdef?pvs=21)

>担当者にタスクが自動で割り当てられる
新規の問い合わせだから担当者は存在していないのでは？ |  |
| B-BE-002 | **既存顧客**から再度メールを送信する | 1. 新規顧客としては登録されない<br>2. 既存の専用ルームに、新しいメッセージとしてメール内容が追加される | 25/10/23　井上文 | 〇 | `handleCustomer` `handleChannel`の既存チェック |  |
| B-BE-003 | 特定フォーマットのメールを送信する（例：`akane`） | メール本文の`【お客様情報】`などが正しく解析され、顧客名、連絡先などが顧客情報として登録されること。 | 25/10/23　井上文 | △ | `parseEmail`の`akane`ケース

初回にデータが取得できなかった場合、次回以降に書式やパーソナル情報が含まれていたとしても、取得出来ていない可能性がある |  |
| B-BE-004 | LLMによる解析が必要な自由形式のメールを送信する | LLMがメール本文から顧客名、会社名、連絡先などを抽出し、顧客情報として登録されること。 | 25/10/23　井上文 | テスト内容は不明だが上記と同じ話？ | `parseAutoEmail` `parseEmailWithLLM`のケース |  |
| B-BE-005 | 添付ファイル付きのメールを送信する | 添付ファイルがCloud Storageに保存され、ルーム内のメッセージにファイルとして添付されていること。インライン画像（CID埋め込み）も表示されること。 | 25/10/23　井上文 | △ | `handleFileRegister` `addCidToAttachedFiles`

添付されてきた画像は読み込めている
※DLが出来ない不具合有(別チケットにて以前報告済)
が、インライン画像とやらは作り方が不明なので未テスト |  |
| B-BE-006 | ブラックリストに登録されたアドレスからメールを送信する | 処理が中断され、ルーム作成やメッセージ登録が行われないこと。ログに記録が残ること。 | 25/10/23　井上文 | ブラックリストの方法について確認中 | `getBlackListMail` |  |
| B-BE-007 | 存在しないテナントのメールアドレス宛に送信する | 処理が中断され、エラーとして記録されること。 | 25/10/23　井上文 | 〇？ | よく分からないが[coobal.co.jp-test2@em.follot.biz]という利用中のアドレスを[coobal.co.jp-test3@em.follot.biz]として送信したところ、FBは特に受信しなかったので〇としている |  |

### 3.2 UI表示テスト（フロントエンド）

| 項目ID | 確認内容 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| B-UI-001 | 顧客チャット画面へのアクセス | サイドバーに顧客名ごとのルームリストが表示されること。未読ルームはハイライト表示されること。 | 25/10/23　井上文 | △ | Teamチャットとのサイドバー構成の差異を確認

>未読ルームはハイライト表示

ここについては確認方法不明だが多分実装されていない |
| B-UI-002 | ルーム選択 | ルームを選択すると、その顧客との過去のやり取り（メール含む）が時系列で表示されること。 | 25/10/23　井上文 | 〇 |  |
| B-UI-003 | サイドバーのタスク/連絡先アイコン表示 | 各ルーム名の下に、顧客との連絡手段（メール/LINE）を示すアイコンと、関連タスクのステータスが表示されること。 | 25/10/23　井上文 | △ | `ChannelTask.tsx`
メールの場合はメールアドレス
CWの場合はCWID？

LINEは不明なので確かめてない |
| B-UI-004 | **情報パネル（「！」アイコン）**の表示 | 右肩の「！」アイコンをクリックすると、情報パネルが開く。パネル上部に「表示概要」「顧客」「ノート」のタブが表示されること。 | 25/10/23　井上文 | 〇 | `SubCol/content-info` |
| B-UI-005 | 情報パネルの「顧客」タブ | 顧客の連絡先、会社名などの詳細情報が表示されること。 | 25/10/23　井上文 | 〇 | `OptimizedCustomerProfile` |
| B-UI-006 | 情報パネルの「表示概要」タブ | ルームに関する共有メモが表示されること。 | 25/10/23　井上文 | 〇 |  |
| B-UI-007 | 情報パネルのアコーディオンメニュー | 「顧客リスト」「ルーム情報」「メンバーリスト」のアコーディオンメニューが表示され、開閉できること。 | 25/10/23　井上文 | 〇 |  |

### 3.3 機能テスト（メッセージ送信・承認フロー）

| 項目ID | 操作 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| B-FUNC-001 | **承認が不要**な設定でメッセージを送信する | Teamチャット同様、メッセージが即時送信され、顧客への返信メールが送信されること。 | 25/10/23　井上文 | 〇 | `shouldOpenApprovalModal`がfalseのケース |
| B-FUNC-002 | **承認が必要**な設定でメッセージを送信する | 1. 送信ボタンクリック後、「送信前に確認を依頼する」等の選択肢がある確認モーダルが表示されること。<br>2. 「確認依頼」をすると、メッセージは「pending (承認待ち)」状態で表示されること。 | 25/10/23　井上文 | 〇 | `shouldOpenApprovalModal`がtrueのケース

[**送信保留中]**が現状の管理画面の表示 |
| B-FUNC-003 | 承認依頼を出す | 確認依頼をすると、指定された承認者のタスクに「メール内容の確認依頼」が作成されること。 | 25/10/23　井上文 | 〇 | `confirmRequest`の処理 |
| B-FUNC-004 | 承認者がメッセージを承認する | メッセージのステータスが「sent」に更新され、顧客にメールが送信されること。（承認機能のテストと連携） | 25/10/23　井上文 | △ | 現状のFBにおいて、メッセージ確認のコマンドに[承認]という方法はもうない気がします |
| B-FUNC-005 | 承認者がメッセージを差し戻す | メッセージが下書き状態に戻り、送信者が編集可能になること。（承認機能のテストと連携） |  |  |  |
| B-FUNC-006 | 「確認せずに送信」を選択する | 承認フローをスキップして、メッセージが即時送信されること。 | 25/10/23　井上文 | 〇 |  |
| B-FUNC-007 | **承認済みメッセージ**の操作 | 承認済みのメッセージ（`condition: 'sent'`）にカーソルを合わせても、「...」メニューに「編集」「取消」が表示されないこと。 |  |  | `action-buttons.tsx`の条件分岐 |

### 3.4 機能テスト（サイドバー・情報パネル・フォーム操作）

| 項目ID | 操作 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| B-SIDE-001 | 「ルーム」横の3点リーダーをクリック | 「ルーム追加」「一括操作モード」「ブラックリスト一覧」のメニューが表示されること。 | 25/10/23　井上文 | 〇 | `AccordionListCustomerChat` |
| B-SIDE-002 | 「一括操作モード」を選択 | 各ルームの横にチェックボックスが表示され、複数のルームを選択できるようになること。フッターに「一括削除」などのアクションバーが表示されること。 | 25/10/23　井上文 | 〇 | `businessChat:bulkDelete`権限が必要 |
| B-SIDE-003 | 各ルーム横の3点リーダーをクリック | 「概要」「メンバー」「削除（顧客情報含む）」「削除（顧客、ブラックリスト）」のメニューが表示されること。 | 25/10/23　井上文 | 〇 | `PortalDropdownMenu` |
| B-SIDE-004 | サイドバーのタスクステータスをクリック | 関連するタスクの編集モーダルが開くこと。 | 25/10/23　井上文 | 〇 | `toggleModalFormOpen` |
| B-SIDE-005 | **フォーム下部**の「タスク作成」ボタンをクリック | そのルームに紐づく新規タスクの作成モーダルが開くこと。 | 25/10/23　井上文 | 〇 | `action-buttons.tsx`

差異新仕様だと　タスク作成→更新　だと思われる |
| B-SIDE-006 | **情報パネル**の「表示概要」タブで編集ボタンをクリック | 共有メモの編集モーダルが開くこと。 | 25/10/23　井上文 | 〇 | `SharedMemoFormModal` |
| B-SIDE-007 | **情報パネル**の「顧客」タブで編集ボタンをクリック | 顧客情報の編集モーダルが開くこと。 | 25/10/23　井上文 | 〇 | `CustomerFormModal`
顧客情報というか顧客追加モーダルが展開されている |

### 3.5 権限テスト

| 項目ID | ユーザーロール | 操作/確認箇所 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- | --- |
| B-AUTH-001 | ユーザー (`User`) | メッセージの編集・削除 | 自分の送信したメッセージ（未承認）に対してのみ、編集・削除ボタンが表示・機能すること。 | 25/10/23　井上文 | × | `isMyMessage`
[編集]＆[取消⇆復元]コマンドはあるが、削除コマンドは存在しない |
| B-AUTH-002 | Bizトークゲスト (`Customer`) | メッセージの編集・削除 | `User`ロールと同様、自分のメッセージ（未承認）のみ編集・削除が可能であること。 | 25/10/23　井上文 | × | `isMyMessage`
Bizトークゲストで送信しようとすると承認確認のフローが無くノンストップでそのまま送信してしまう
※編集削除は出来ず、リアクションだけ可能 |
| B-AUTH-003 | 運用管理者 (`Manager`) | メッセージの編集・削除 | 他人のメッセージを含め、すべての**未承認**メッセージの編集・削除が可能であること。 | 25/10/23　井上文 | 〇 | `static` |
| B-AUTH-004 | ユーザー (`User`) | サイドバー「ルーム」横の3点リーダー | 「一括操作モード」「ブラックリスト一覧」が表示されないこと。 | 25/10/23　井上文 | × | `businessChat:bulkDelete` `blackListMail:list`権限の有無

[tester+user03@coobal.co.jp](mailto:tester+user03@coobal.co.jp)　で確認した感じ「一括操作モード」「ブラックリスト一覧」も表示されている

 |
| B-AUTH-005 | ユーザー (`User`) | 承認待ちメッセージの閲覧 | `(送信を準備しています)`と表示され、内容は閲覧できないこと。 | 25/10/23　井上文 | × | `message:viewPending`権限の有無

承認待ちの状態というのが現状作れていないのではないかと思う |
| B-AUTH-006 | ユーザー (`User`) | フォーム下部のタスクボタン | タスク関連のボタン（ステータス表示 or 新規作成）が表示されないこと。 | 25/10/23　井上文 | × | `businessChat:viewChannelTask`権限

ユーザー権限の入力フォーム下部にはタスク作成ボタン等の物は見当たらない |
| B-AUTH-007 | ユーザー (`User`) | 情報パネルのタブ表示 | 「顧客」「ノート」タブが表示されず、「表示概要」タブのみ表示されること。 | 25/10/23　井上文 | × | `businessChat:viewCustomerInfo`等の権限

ユーザー権限では　表示概要/顧客/ノート　が表示されている |
| B-AUTH-008 | ユーザー (`User`) | 情報パネルの「表示概要」編集 | 編集ボタンが表示されず、共有メモの編集ができないこと。 | 25/10/23　井上文 | × | `businessChat:editSharedMemo`権限

編集できます |
| B-AUTH-009 | **クーバル権限** (`isSuperAdmin: true`) | すべての機能 | 通常は権限のない操作（他ユーザーのメッセージ削除、管理者限定メニューの表示・操作など）がすべて実行可能であること。**ただし、承認済みメッセージの編集・取消は不可**。 | 25/10/23　井上文 | △ | `isSuperAdmin`でも`condition: 'sent'`のチェックは適用されるか確認

[tester+teamchatguest04@coobal.co.jp](mailto:tester+teamchatguest04@coobal.co.jp)
(Bizトークゲスト)で確認したところ、確かに色んな操作ができるようになっていた
承認済メッセージ～については確認がとれていないので一応△としてある |

*注: メッセージ入力、ファイル添付、スレッド機能など、基本的なチャットUIの挙動については、Teamチャット機能（2.x系）のテスト項目に準ずる。本仕様書では顧客チャット特有の機能・差分を中心に記述する。*