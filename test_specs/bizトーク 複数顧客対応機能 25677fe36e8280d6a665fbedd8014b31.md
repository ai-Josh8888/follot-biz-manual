# bizトーク 複数顧客対応機能

# 【テスト仕様書】複数顧客対応機能（フェーズ0）

## 基本情報

- **作成日**: 2025年8月21日
- **対象バージョン**: フェーズ0完了版
- **テスト対象**: 複数顧客対応機能（bizトーク・メール受信処理・UI表示）
- **関連実装**:
    - `functions-node22/src/concerns/channel.ts` (handleChannel関数)
    - `src/components/ecosystems/SubCol/content-info/index.tsx` (primaryCustomer表示)
    - `src/components/ecosystems/SubCol/content-info/accordion-contents/customer-list.tsx` (顧客ステータス表示)

---

## 5. 複数顧客対応機能

### 基本情報

- **機能概要**: 1つのルーム（チャンネル）に複数顧客を関連付け、bizトークゲスト優先表示・メール受信処理・UI表示を行う機能
- **データ構造**:
    - `Channel.customers: string[]` - 全関連顧客ID
    - `Channel.customerUsers: string[]` - bizトークゲスト顧客ID
    - `ContactDetail.type` - 顧客のチャンネル種別（Email/LINE/ChatWork/Slack/Bizトーク）

### テスト項目

### 5.1 バックエンド機能テスト（Cloud Functions）

| 項目ID | 操作 | 期待結果 | 実施者 | 結果(テスト備考) | 備考 |
| --- | --- | --- | --- | --- | --- |
| MC-BE-001 | **新規顧客**からメール受信（handleChannel - 顧客ID検索） | 1. `externalKey`ではなく`customers`配列で検索される<br>2. 該当チャンネルが見つからない場合、新規チャンネル作成<br>3. `customers`配列に顧客IDが追加される | 25/10/24　井上文 | 〇：2.該当チャンネルが見つからない場合、新規チャンネル作成 | array-contains検索の確認

１，３については不明 |
| MC-BE-002 | **既存チャンネルの顧客**からメール受信 | 1. 既存チャンネルが正しく検索される<br>2. 新規チャンネル作成されない<br>3. メッセージが既存チャンネルに追加される | 25/10/24　井上文 | 〇 | `handleChannel`既存検索 |
| MC-BE-003 | **新規顧客を既存チャンネルに追加**してメール受信 | 1. 既存チャンネルに新規顧客からのメールが追加される<br>2. 情報パネルの顧客リストに新規顧客が追加表示される<br>3. 既存顧客は引き続き表示される | 25/10/24　井上文 | 〇 | 顧客管理画面での確認

疑問：元々のルーム主だった顧客には、新規に追加された顧客のメール内容が転送されないが、これは正しいのか

[https://www.notion.so/da726d34a9684f2ca15ec6aab033fc2f?v=1d277fe36e828085bd31000cc6db4a03&p=29677fe36e828039b374d1adc613870d&pm=s](https://www.notion.so/Biz-29677fe36e828039b374d1adc613870d?pvs=21) |
| MC-BE-004 | **複数顧客からの同時メール受信** | 1. 各顧客のメールが同一チャンネルに正しく配信される<br>2. 顧客IDベース検索が正常動作<br>3. 競合状態でのデータ整合性確保 | 25/10/24　井上文 | 〇 | 並行処理テスト |
| MC-BE-005 | **顧客削除操作** | 1. 情報パネルで顧客を削除すると、そのルームから顧客が除外される<br>2. 最後の1人の顧客は削除できない（「顧客は少なくとも1名は必要です」表示）<br>3. 削除後、顧客リスト表示から対象顧客が消える | 25/10/24　井上文 | × | 顧客管理画面での操作確認

[https://www.notion.so/da726d34a9684f2ca15ec6aab033fc2f?v=1d277fe36e828085bd31000cc6db4a03&p=29677fe36e8280d5abdce347bf54cbeb&pm=s](https://www.notion.so/BUG-Biz-29677fe36e8280d5abdce347bf54cbeb?pvs=21) |

### 5.2 フロントエンド表示テスト（顧客表示優先度）

| 項目ID | 確認内容 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| MC-UI-001 | **bizトークユーザー優先表示** | 複数顧客がいる場合、bizトークユーザーが最初に表示されること | 25/10/25　井上文 | × | ゲスト顧客の優先表示

[【BUG？】Bizトーク-複数顧客対応：複数顧客の内、1顧客をBizトークゲストとしてアカウントを付与しても、ルーム内の表示で優先度が高位になっていない](https://www.notion.so/BUG-Biz-1-Biz-29777fe36e8280fb9087e02eb4c87766?pvs=21)
 |
| MC-UI-002 | **Email顧客のみの場合の表示** | bizトークユーザーがいない場合、Email顧客が表示されること | 25/10/24　井上文 | 〇 | Email顧客フォールバック |
| MC-UI-003 | **顧客なし時の表示** | 顧客が存在しない場合、顧客情報カードが表示されないこと | 25/10/25　井上文 | ？ | 空状態の表示

顧客なし状態のルームを作成することが不可能 |
| MC-UI-004 | **チャンネル切り替え時の表示** | チャンネル切り替え時、正しい顧客情報が表示されること | 25/10/25　井上文 | × | 切り替え時の表示更新

[【BUG？】Bizトーク：チャンネルを切り替える際、読み込み中の間に別のチャンネルを押下すると、サイドバーは最新の選択が反映されつつも、メインチャット内容は先ほど読み込んでいた一つ前のチャンネルの内容を表示してしまう](https://www.notion.so/BUG-Biz-29777fe36e82809ab631c4f26639f992?pvs=21) |
| MC-UI-005 | **顧客追加時の表示更新** | 新しい顧客を追加した際、表示が即座に更新されること | 25/10/25　井上文 | 〇 | リアルタイム表示更新

[新しい顧客追加時にルーム名やメインチャット欄上の情報などがそちらに上書かれてしまうが問題ないか](https://www.notion.so/Biz-29677fe36e828039b374d1adc613870d?pvs=21) |
| MC-UI-006 | **ノートタブの表示制御** | 顧客にノート機能がある場合、ノートタブが表示されること | 25/10/25　井上文 | ？？？ | ノートタブ表示条件
↑
出現条件教えてください

現状、ただのメールからの顧客＋Bizトークゲスト顧客のルームではノートが表示されておらず、
ただのメールからの顧客のチャンネルではノートアイコンが確認できた

[【BUG?】顧客ノート：顧客ノートページにて同名の顧客情報が複数並んでいる](https://www.notion.so/BUG-29777fe36e828051819ece4e2abad7b5?pvs=21) |

### 5.3 UI機能テスト（顧客リスト表示）

| 項目ID | 操作 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| MC-LIST-001 | **顧客リスト表示** | 情報パネルの「顧客」アコーディオンに全関連顧客が一覧表示されること | 25/10/25　井上文 | 〇 | 顧客一覧表示 |
| MC-LIST-002 | **bizトークユーザー表示** | bizトークに参加している顧客に「(Bizトーク)」が表示されること | 25/10/25　井上文 | 〇 | ユーザー状態表示 |
| MC-LIST-003 | **Email顧客表示** | Email経由の顧客に「(Email)」が表示されること | 25/10/25　井上文 | × | Email顧客識別 |
| MC-LIST-004 | **LINE顧客表示** | LINE経由の顧客に「(LINE)」が表示されること | 25/10/25　井上文 | 未確認 | LINE顧客識別 |
| MC-LIST-005 | **ChatWork顧客表示** | ChatWork経由の顧客に「(ChatWork)」が表示されること | 25/10/25　井上文 | 未確認 | ChatWork顧客識別 |
| MC-LIST-006 | **Slack顧客表示** | Slack経由の顧客に「(Slack)」が表示されること | 25/10/25　井上文 | 未確認 | Slack顧客識別 |
| MC-LIST-007 | **複数チャンネル顧客表示** | 複数のサービスを使用する顧客に「(Email, LINE)」等が表示されること | 25/10/25　井上文 | 未確認 | 複数サービス表示 |
| MC-LIST-008 | **顧客名表示** | 顧客の正式名称が正しく表示されること | 25/10/25　井上文 | 〇 | 名前表示確認

顧客管理に登録されている名称がそのまま反映されているようだ |

### 5.4 顧客管理機能テスト（顧客編集フォーム）

| 項目ID | 操作 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| MC-MGMT-001 | **顧客追加機能** | 1. 「編集」ボタンから追加可能な顧客が選択できる<br>2. 「追加する」ボタンクリック後、顧客リストに追加される<br>3. 情報パネルの顧客リストに即座に表示される | 25/10/25　井上文 | 〇 | 顧客追加操作 |
| MC-MGMT-002 | **顧客削除機能** | 1. 「除外する」ボタンで顧客を削除できる<br>2. 最後の顧客は削除不可（「顧客は少なくとも1名は必要です」表示）<br>3. 削除後、顧客リストから即座に除去される | 25/10/25　井上文 | 〇 | 顧客削除操作 |
| MC-MGMT-003 | **追加可能顧客フィルタリング** | 既に当ルームにいる顧客は追加選択肢に表示されないこと | 25/10/25　井上文 | 〇 | 重複防止機能 |
| MC-MGMT-004 | **顧客アイコン表示** | 顧客選択時と一覧で、アイコンが正しく表示されること | 25/10/26　井上文 | 〇 | アイコン表示確認 |
| MC-MGMT-005 | **顧客情報表示** | 顧客詳細情報（会社名、連絡先等）が正しく表示されること | 25/10/26　井上文 | △ | 詳細情報表示

最初に来たメールの署名形式によっては読み込めていない可能性がある |

### 5.5 データ整合性テスト

| 項目ID | 確認内容 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| MC-DATA-001 | **外部サービス連携情報** | LINE、ChatWork、Slack連携時の顧客情報が正しく表示されること | 25/10/26　井上文 | 未確認 | 外部連携データ確認 |
| MC-DATA-002 | **顧客データ整合性** | 顧客リストに表示される顧客情報がプロフィール画面と一致すること | 25/10/26　井上文 | 〇 | データ一致確認

一致はしていると思うが、顧客の場合画像アイコン等の登録画面がないみたいだが、それは問題ないのか |
| MC-DATA-003 | **bizトークユーザー判定** | bizトークに参加している顧客が正しく識別されること | 25/10/26　井上文 | 〇 | ユーザー状態確認 |
| MC-DATA-004 | **連絡手段表示** | 顧客の利用可能な連絡手段（Email/LINE等）が正しく表示されること | 25/10/26　井上文 | 〇 | 連絡手段確認 |
| MC-DATA-005 | **リアルタイム更新** | 顧客情報変更時、画面表示が即座に更新されること | 25/10/26　井上文 | △ | 表示同期確認

反映はされるが、概要(サブカラム展開)＞顧客アイコン＞編集で情報が更新された場合、リロードしないと表示情報は更新されない |

### 5.6 エラーハンドリングテスト

| 項目ID | 操作 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| MC-ERR-001 | **削除された顧客の処理** | 削除された顧客がリストにある場合、エラー表示または非表示になること | 25/10/26　井上文 | 〇(期待値映えるが別の問題が発生) | 削除顧客の処理

[【BUG】顧客管理：顧客情報を削除するとエラーページに遷移する](https://www.notion.so/BUG-29877fe36e8280a28735d48ba6bd41cc?pvs=21)

[【質問】Bizトーク：ルームに紐づいていた唯一の顧客情報が削除された際の挙動](https://www.notion.so/Biz-29877fe36e82803c9f69e9f6f3b01c92?pvs=21) |
| MC-ERR-002 | **不正な連絡手段データ** | 不正な連絡手段情報がある場合、エラー表示またはデフォルト表示されること | 25/10/26　井上文 | 確認方法不明 | データ異常処理 |
| MC-ERR-003 | **顧客なしの状態** | 顧客が0人の状態で適切にエラーが表示されること | 25/10/26　井上文 | × | 空状態処理

[【質問】Bizトーク：ルームに紐づいていた唯一の顧客情報が削除された際の挙動](https://www.notion.so/Biz-29877fe36e82803c9f69e9f6f3b01c92?pvs=21) |
| MC-ERR-004 | **ネットワークエラー** | 顧客データ読み込み失敗時、適切なエラーメッセージが表示されること | 25/10/26　井上文 | 確認方法不明 | 通信エラー表示 |

### 5.7 パフォーマンステスト(現状見送り)

| 項目ID | 確認内容 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| MC-PERF-001 | **大量顧客表示** | 50人以上の顧客がいる場合でも、リスト表示が2秒以内に完了すること |  |  | 大量データ表示性能 |
| MC-PERF-002 | **顧客情報表示速度** | 顧客情報の表示・更新がスムーズに行われること |  |  | 表示性能 |
| MC-PERF-003 | **チャンネル切り替え性能** | チャンネル切り替え時、顧客情報表示が1秒以内に更新されること |  |  | 切り替え性能 |

---

## 回帰テスト項目

### 既存機能への影響確認

| 項目ID | 確認内容 | 期待結果 | 実施者 | 結果 | 備考 |
| --- | --- | --- | --- | --- | --- |
| MC-REG-001 | **単一顧客チャンネル** | 従来の単一顧客チャンネルが正常動作すること | 25/10/26　井上文 | 〇 | 後方互換性 |
| MC-REG-002 | **DMチャンネル** | DMチャンネルの表示・動作に影響がないこと | 25/10/26　井上文 | × | DM機能維持

[【BUG】user_profiles：DMやBizトーク内のユーザーアイコンを押下した際、ユーザープロファイルが提示される想定だが、もう一度アイコンを押すとプロファイルが消えて空のサブカラムが表示される](https://www.notion.so/BUG-user_profiles-DM-Biz-29877fe36e82804a8579c550db4af040?pvs=21) |
| MC-REG-003 | **TeamChatチャンネル** | TeamChatチャンネルの動作に影響がないこと | 25/10/26　井上文 | × | TeamChat機能維持

[【BUG】タスクアイコン：チャット欄の択すアイコンを押下すればするほどURLが長くなり、サブカラムにもタスクが表示されなくなる](https://www.notion.so/BUG-URL-29877fe36e828005b676ff97e9ac9239?pvs=21) |
| MC-REG-004 | **メール送信機能** | 既存のメール送信機能が正常動作すること | 25/10/26　井上文 | × | sendEmailToCustomer

[【BUG】Bizトーク：「送信前に確認を依頼する」として、メッセージを[送信保留中]とした場合、その後に該当メッセージを送信すると[送信処理中]ステータスに切り替わったまま維持され送信されない](https://www.notion.so/BUG-Biz-29577fe36e8280f29cf5cf6477afb5e3?pvs=21) |
| MC-REG-005 | **承認フロー** | メッセージ承認フローが正常動作すること | 25/10/26　井上文 | × | 承認機能維持

[【BUG】Bizトーク：「送信前に確認を依頼する」として、メッセージを[送信保留中]とした場合、その後に該当メッセージを送信すると[送信処理中]ステータスに切り替わったまま維持され送信されない](https://www.notion.so/BUG-Biz-29577fe36e8280f29cf5cf6477afb5e3?pvs=21) |

---

## 注意事項

1. **テスト環境**: 本テストはstaging環境で実施すること
2. **権限テスト**: 各ロール（User, Manager, Customer等）での動作確認を必ず実施すること

*注: 本テスト仕様書はフェーズ0（複数顧客対応基盤）の機能に特化しています。外部サービス連携（LINE/Slack/ChatWork）の詳細テストは、フェーズ1以降の仕様書で記述予定です。*